<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.58.3"><title>画像データをサーバーにPOSTする - 1mmもわからん</title><meta property=og:title content="画像データをサーバーにPOSTする - 1mmもわからん"><link href=https://raahii.github.io/favicon.ico rel=icon type=image/x-icon><link rel=icon href=https://raahii.github.io/images/favicon.ico type=image/x-icon><link rel=stylesheet href=https://raahii.github.io/css/main.css media=all><link rel=stylesheet href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700"></head><body><div class=wrapper><header class=header><nav class=nav><a href=https://raahii.github.io/ class=nav-logo><img src=https://raahii.github.io/images/logo.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/about/>About</a></li><li><a href=https://github.com/raahii>GitHub</a></li><li><a href=https://twitter.com/raahiiy>Twitter</a></li></ul></nav></header><main class=content role=main><article class=article><span class=article-duration>1 min read</span><h1 class=article-title>画像データをサーバーにPOSTする</h1><span class=article-date>August 4, 2019</span><div class=article-content><p>機械学習を使ったサービス/アプリを開発しているとクライアントから画像をサーバーに送って推論して結果を返す，ということをよくやるのでメモ．</p><h2 id=1枚しか送らない場合>1枚しか送らない場合</h2><p>今の所自分はこのパターンが多いです．いくつか実現方法はあると思いますが，リクエストボディに直接画像データのバイナリを入れて送る方法がシンプルで好きです．クライアント側のコードはこんな感じ．</p><pre><code class=language-python>import json
import urllib.parse
import urllib.request

# read image data
f = open(&quot;example.jpg&quot;, &quot;rb&quot;)
reqbody = f.read()
f.close()

# create request with urllib
url = &quot;http://localhost:5000&quot;
req = urllib.request.Request(
    url,
    reqbody,
    method=&quot;POST&quot;,
    headers={&quot;Content-Type&quot;: &quot;application/octet-stream&quot;},
)

# send the request and print response
with urllib.request.urlopen(req) as res:
    print(json.loads(res.read()))
</code></pre><p>注意点として Content-Type に <code>application/octet-stream</code> を指定すると良いです．このMIMEタイプは曖昧なバイナリデータを指しており，ファイル種別を特に指定しないことを意味します（ref: <a href=https://www.iana.org/assignments/media-types/application/octet-stream>MIME type: application/octet-stream</a> ）．</p><p>urllibの場合，これを指定しないとPOSTのデフォルトのMIMEタイプである <code>application/x-www-form-urlencoded</code> となり，サーバー側で正しく受け取れないので気をつけてください．</p><p>一方でサーバー側（flaskの場合）のコードはこのようになります．画像データをOpenCVで読んで画像のshapeをjsonで返しています．</p><pre><code class=language-python>@app.route(&quot;/&quot;, methods=[&quot;POST&quot;])
def example():
    # read request body as byte array
    _bytes = np.frombuffer(request.data, np.uint8)
    # decode the bytes to image directly
    img = cv2.imdecode(_bytes, flags=cv2.IMREAD_COLOR)

    return jsonify(img.shape)
</code></pre><p>ポイントはリクエストボディのバイト列を直接OpenCVのAPIで画像として読み込んでいるところです．この部分，一度画像データをファイルに書き出してから改めて読んでいるコードをよく見かけますが，直接できます．しかもこの方法だとjpegでもpngでも関係なく画像データに落とし込めるのでとっても楽です（OpenCVが優秀なだけ？）．</p><h2 id=複数枚送る場合>複数枚送る場合</h2><p>バッチ処理なんかしたい場合は複数枚を同時に送りたいこともあると思います．その場合はやはり <code>multipart/form-data</code> だと思います（まぁそのためにあるので）．<code>multipart/form-data</code> は複数のファイルデータをBoundary文字列
で区切って連結し，送信する方法です．</p><p>ただその分，先のリクエスト方法よりも複雑なのでライブラリを使うと楽です．clientのサンプルコードです．</p><pre><code class=language-python>import requests

images = {}
for i, f in enumerate([&quot;example.jpg&quot;, &quot;example.png&quot;]):
    f = open(f, &quot;rb&quot;)
    images[str(i)] = f.read()

url = &quot;http://localhost:5000/multi&quot;
res = requests.post(url, files=images)
print(res.json())
</code></pre><p>この場合，送りたい画像データはただの配列なのですが，どうやらdictで渡さないといけないようなので，indexを文字列にしてkeyとしました．これを使ってサーバー側のコードで順序を保証して取り出します．</p><pre><code class=language-python>@app.route(&quot;/&quot;, methods=[&quot;POST&quot;])
def example():
    # sort by key as integer
    files = sorted(request.files.items(), key=lambda x: int(x[0]))

    images = []
    for f in files:
        _bytes = np.frombuffer(f[1].read(), np.uint8)
        img = cv2.imdecode(_bytes, flags=cv2.IMREAD_COLOR)

        images.append(img.shape)

    return jsonify(images)
</code></pre><p>あんまりキレイではないですが，こんな感じでできます．ちなみに，画像データ以外のjsonデータを送りたい場合なんかも同様に <code>multipart/form-data</code>を使ってできるので万能ですね．</p><h2 id=所感>所感</h2><p>覚えたぞ，<code>application/octet-stream</code>．</p></div></article><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"raahii"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><footer class=footer><ul class=footer-links><li><a href=https://gohugo.io/ class=footer-links-kudos>Made with <img src=https://raahii.github.io/images/hugo-logo.png width=22 height=22></a></li></ul></footer></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-86522604-4','auto');ga('send','pageview');}</script></body></html>